name: Depends Export Workflow

on:
  push:
    branches:
      - main
    paths:
      - "uv.lock"

jobs:
  export-dependencies:
    runs-on: windows-latest
    steps:
      # 签出代码
      - name: Checkout
        uses: actions/checkout@main

      # 配置 uv 
      - name: Setup UV for Python
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/uv.lock

      # 安装依赖
      - name: Install dependencies
        run: |
          uv sync --frozen
    
      # 导出依赖列表
      - name: Export dependencies
        run: |
          uv run python ./scripts/export-requirements-from-uv-lock.py

      # 检查更改并生成报告
      - name: Generate changes report
        id: changes-report
        shell: bash
        run: |
            # 检查文件是否发生变化
            if git diff --quiet requirements.txt; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
            fi
            
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # 生成添加和删除的统计
            ADDED_LINES=$(git diff --numstat requirements.txt | awk '{print $1}')
            DELETED_LINES=$(git diff --numstat requirements.txt | awk '{print $2}')
            
            # 获取具体的包变更
            ADDED_PACKAGES=$(git diff --unified=0 requirements.txt | grep '^\+[^+]' | grep -v '^+++' | sed 's/^\+//' | head -20)
            REMOVED_PACKAGES=$(git diff --unified=0 requirements.txt | grep '^\-[^-]' | grep -v '^---' | sed 's/^\-//' | head -20)
            
            {
            echo "added_lines=$ADDED_LINES"
            echo "deleted_lines=$DELETED_LINES"
            echo "added_packages<<EOF"
            echo "$ADDED_PACKAGES"
            echo "EOF"
            echo "removed_packages<<EOF"
            echo "$REMOVED_PACKAGES"
            echo "EOF"
            } >> $GITHUB_OUTPUT
    
      # 提交更改并创建 PR
      - name: Create Pull Request
        if: steps.changes-report.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update requirements.txt from uv.lock"
          title: "chore: update requirements.txt"
          body: |
            ## Dependency Updates
            
            This PR updates `requirements.txt` based on changes in `uv.lock`.
            
            ### Change Statistics
            - **Added lines**: ${{ steps.changes-report.outputs.added_lines }}
            - **Deleted lines**: ${{ steps.changes-report.outputs.deleted_lines }}
            
            ### Added/Updated Packages
            ```
            $ADDED_PACKAGES
            ```
            
            ### Removed Packages
            ```
            $REMOVED_PACKAGES
            ```
            
            ---
            *Auto-generated by GitHub Actions*
          branch: update-requirements-txt
          delete-branch: true
        env:
          ADDED_PACKAGES: ${{ steps.changes-report.outputs.added_packages }}
          REMOVED_PACKAGES: ${{ steps.changes-report.outputs.removed_packages }}